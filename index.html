<html>
<head>
<link rel="stylesheet" type="text/css" href="styles.css">
<title>
Component OPRs
</title>
</head>
<body>
    <table id="opr_table" style="width:100%;">
        <!--Generated items will go here-->
    </table>
</body>

<script id="header-table" type="text/template">
    <tr class="header">
        <td rowspan="2">Team</td>
        <td rowspan="2">OPR</td>
        <td rowspan="2">Starting Avg</td>
        <td rowspan="2">Climb Avg</td>
        <td colspan="6">Cargoship OPR</td>
        <td colspan="8">Rocket OPR</td>
    </tr>
    <tr class="header">
        <td>Hatch</td>
        <td>Hatch (side)</td>
        <td>Hatch (front)</td>
        <td>Cargo</td>
        <td>Cargo (side)</td>
        <td>Cargo (front)</td>
        <td>Hatch</td>
        <td>Hatch (top)</td>
        <td>Hatch (mid)</td>
        <td>Hatch (low)</td>
        <td>Cargo</td>
        <td>Cargo (top)</td>
        <td>Cargo (mid)</td>
        <td>Cargo (low)</td>
    </tr>
</script>

<script id="template-table-entry" type="text/template">
    <tr class="content">
        <td><a href="{{url}}">{{team}}</a></td>
        <td>{{opr}}</td>
        <td>{{start_avg}}</td>
        <td>{{climb_avg}}</td>
        <td>{{cargo_panel_opr}}</td>
        <td>{{cargo_side_panel_opr}}</td>
        <td>{{cargo_front_panel_opr}}</td>
        <td>{{cargo_cargo_opr}}</td>
        <td>{{cargo_side_cargo_opr}}</td>
        <td>{{cargo_front_cargo_opr}}</td>
        <td>{{rocket_panel_opr}}</td>
        <td>{{rocket_high_panel_opr}}</td>
        <td>{{rocket_mid_panel_opr}}</td>
        <td>{{rocket_low_panel_opr}}</td>
        <td>{{rocket_cargo_opr}}</td>
        <td>{{rocket_high_cargo_opr}}</td>
        <td>{{rocket_mid_cargo_opr}}</td>
        <td>{{rocket_low_cargo_opr}}</td>
    </tr>
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/5.6.0/math.js"></script>
<script>

    var apiKey = 'LCBZ7qqYrBR0e06C4QJEjaW1O7r2TZat7KZwvQcfDqShwIxV4N7epHK9lbafjc4M';
    var baseURL = 'https://www.thebluealliance.com/api/v3';

    function httpGet(url, callback)
    {
        axios.get(baseURL + url, { 'headers': { 'X-TBA-Auth-Key': apiKey } })
        .then((response) => {
            callback(response.data);
        })
        .catch((error) => {
            console.log(error);
        });
    }

    function countInArray(array, value) {
        return array.reduce((n, x) => n + (x === value), 0);
    }

    function getMatches(code, callback)
    {
        httpGet('/event/' + code + '/matches', callback);
    }

    function parseMatch(complete_match_data)
    {
        var match = complete_match_data.score_breakdown;

        var colors = ['blue', 'red'];

        var low_rocket = [
                            'lowLeftRocketFar',
                            'lowRightRocketFar',
                            'lowLeftRocketNear',
                            'lowRightRocketNear',
                        ];
        var mid_rocket = [
                            'midLeftRocketFar',
                            'midRightRocketFar',
                            'midLeftRocketNear',
                            'midRightRocketNear',
                        ];
        var high_rocket = [
                            'topLeftRocketFar',
                            'topRightRocketFar',
                            'topLeftRocketNear',
                            'topRightRocketNear',
                        ];

        var results = {};

        for (var color in colors) {

            var cargo_side_panels = 0;
            var cargo_side_cargo = 0;
            var cargo_front_panels = 0;
            var cargo_front_cargo = 0;

            for (var i = 1; i <= 8; i++) {

                var bay = match[colors[color]]['bay' + i].replace('And', '');
                var scored_bay = bay.replace(match[colors[color]]['preMatchBay' + i], '');

                if (scored_bay.includes('Cargo')) {
                    if (i == 4 || i == 5)
                        cargo_front_cargo++;
                    else
                        cargo_side_cargo++;
                }
                if (scored_bay.includes('Panel')) {
                    if (i == 4 || i == 5)
                        cargo_front_panels++;
                    else
                        cargo_side_panels++;
                }
            }

            var rocket_high_panels = 0;
            var rocket_mid_panels = 0;
            var rocket_low_panels = 0;

            var rocket_high_cargo = 0;
            var rocket_mid_cargo = 0;
            var rocket_low_cargo = 0;

            for (var i = 0; i < 4; i++) {
                var top = match[colors[color]][high_rocket[i]].replace('And', '');
                if (top.includes('Cargo'))
                    rocket_high_cargo++;
                if (top.includes('Panel'))
                    rocket_high_panels++;
                var mid = match[colors[color]][mid_rocket[i]].replace('And', '');
                if (mid.includes('Cargo'))
                    rocket_mid_cargo++;
                if (mid.includes('Panel'))
                    rocket_mid_panels++;
                var low = match[colors[color]][low_rocket[i]].replace('And', '');
                if (low.includes('Cargo'))
                    rocket_low_cargo++;
                if (low.includes('Panel'))
                    rocket_low_panels++;
            }

            for (var i = 1; i <= 3; i++) {
                var robot_start = parseInt(match[colors[color]]['preMatchLevelRobot' + i].replace('HabLevel', ''));
                var robot_climb = parseInt(match[colors[color]]['endgameRobot' + i].replace('HabLevel', ''));
                var robot_auto_move = match[colors[color]]['habLineRobot' + i] == 'CrossedHabLineInSandstorm';
            
                var robot = parseInt(complete_match_data.alliances[colors[color]].team_keys[i-1].replace('frc', ''));
                results[robot] = {
                    'cargo_side_panels': cargo_side_panels,
                    'cargo_side_cargo': cargo_side_cargo,
                    'cargo_front_panels': cargo_front_panels,
                    'cargo_front_cargo': cargo_front_cargo,
                    'rocket_high_panels': rocket_high_panels,
                    'rocket_high_cargo': rocket_high_cargo,
                    'rocket_mid_cargo': rocket_mid_cargo,
                    'rocket_mid_panels': rocket_mid_panels,
                    'rocket_low_panels': rocket_low_panels,
                    'rocket_low_cargo': rocket_low_cargo,
                    'level_start': robot_start,
                    'level_climb': robot_climb,
                    'auto_move': robot_auto_move,
                    'teams_played_with': [
                        parseInt(complete_match_data.alliances[colors[color]].team_keys[0].replace('frc', '')),
                        parseInt(complete_match_data.alliances[colors[color]].team_keys[1].replace('frc', '')),
                        parseInt(complete_match_data.alliances[colors[color]].team_keys[2].replace('frc', ''))
                    ]
                }

            }
        }
        return results;
    }

    function genOPRs(eventCode, callback)
    {
        var results = {};
        getMatches(eventCode, function(matches) {
            for (var match in matches) {
                if (matches[match].actual_time) {
                    var parsed_match = parseMatch(matches[match]);
                    for (var team in parsed_match) {

                        // Initialize entrys
                        if (!(team in results)) {
                            results[team] = {
                                'matches': 0,
                                'cargo_side_panel_sum': 0,
                                'cargo_side_cargo_sum': 0,
                                'cargo_front_panel_sum': 0,
                                'cargo_front_cargo_sum': 0,
                                'rocket_high_panel_sum': 0,
                                'rocket_high_cargo_sum': 0,
                                'rocket_mid_panel_sum': 0,
                                'rocket_mid_cargo_sum': 0,
                                'rocket_low_panel_sum': 0,
                                'rocket_low_cargo_sum': 0,
                                'start_level_2_sum': 0,
                                'start_level_1_sum': 0,
                                'climb_level_3_sum': 0,
                                'climb_level_2_sum': 0,
                                'climb_level_1_sum': 0,
                                'teams_played_with': []
                            };
                        }

                        // Fill sum table
                        results[team].matches += 1;
                        results[team].cargo_side_panel_sum += parsed_match[team].cargo_side_panels;
                        results[team].cargo_side_cargo_sum += parsed_match[team].cargo_side_cargo;
                        results[team].cargo_front_panel_sum += parsed_match[team].cargo_front_panels;
                        results[team].cargo_front_cargo_sum += parsed_match[team].cargo_front_cargo;
                        results[team].rocket_high_panel_sum += parsed_match[team].rocket_high_panels;
                        results[team].rocket_high_cargo_sum += parsed_match[team].rocket_high_cargo;
                        results[team].rocket_mid_panel_sum += parsed_match[team].rocket_mid_panels;
                        results[team].rocket_mid_cargo_sum += parsed_match[team].rocket_mid_cargo;
                        results[team].rocket_low_panel_sum += parsed_match[team].rocket_low_panels;
                        results[team].rocket_low_cargo_sum += parsed_match[team].rocket_low_cargo;
                        results[team].start_level_2_sum += (parsed_match[team].level_start == 2) && (parsed_match[team].auto_move == 1);
                        results[team].start_level_1_sum += (parsed_match[team].level_start == 1) && (parsed_match[team].auto_move == 1);
                        results[team].climb_level_3_sum += parsed_match[team].level_climb == 3;
                        results[team].climb_level_2_sum += parsed_match[team].level_climb == 2;
                        results[team].climb_level_1_sum += parsed_match[team].level_climb == 1;
                        results[team].teams_played_with = results[team].teams_played_with.concat(parsed_match[team].teams_played_with);

                    }

                }
            }

            // Formulate team playing with team array
            var A = [];

            var cargo_side_panel_sums = [];
            var cargo_side_cargo_sums = [];
            var cargo_front_panel_sums = [];
            var cargo_front_cargo_sums = [];
            var rocket_high_panel_sums = [];
            var rocket_high_cargo_sums = [];
            var rocket_mid_panel_sums = [];
            var rocket_mid_cargo_sums = [];
            var rocket_low_panel_sums = [];
            var rocket_low_cargo_sums = [];
            var climb_avgs = [];
            var start_avgs = [];

            for (var team in results) {
                var row = [];
                for (var comparing_team in results) {
                    row.push(countInArray(results[comparing_team].teams_played_with, parseInt(team)));
                }
                A.push(row);
                cargo_side_panel_sums.push(results[team].cargo_side_panel_sum * 2);
                cargo_side_cargo_sums.push(results[team].cargo_side_cargo_sum * 3);
                cargo_front_panel_sums.push(results[team].cargo_front_panel_sum * 2);
                cargo_front_cargo_sums.push(results[team].cargo_front_cargo_sum * 3);
                rocket_high_panel_sums.push(results[team].rocket_high_panel_sum * 2);
                rocket_high_cargo_sums.push(results[team].rocket_high_cargo_sum * 3);
                rocket_mid_panel_sums.push(results[team].rocket_mid_panel_sum * 2);
                rocket_mid_cargo_sums.push(results[team].rocket_mid_cargo_sum * 3);
                rocket_low_panel_sums.push(results[team].rocket_low_panel_sum * 2);
                rocket_low_cargo_sums.push(results[team].rocket_low_cargo_sum * 3);
                climb_avgs.push(
                    (results[team].climb_level_3_sum * 12 + 
                    results[team].climb_level_2_sum * 6 + 
                    results[team].climb_level_1_sum * 3) /
                    results[team].matches);
                start_avgs.push((results[team].start_level_2_sum * 6 + results[team].start_level_1_sum * 3)/results[team].matches);
            }
            var cargo_side_panel_opr = math.lusolve(A, cargo_side_panel_sums);
            var cargo_side_cargo_opr = math.lusolve(A, cargo_side_cargo_sums);
            var cargo_front_panel_opr = math.lusolve(A, cargo_front_panel_sums);
            var cargo_front_cargo_opr = math.lusolve(A, cargo_front_cargo_sums);
            var rocket_high_panel_opr = math.lusolve(A, rocket_high_panel_sums);
            var rocket_high_cargo_opr = math.lusolve(A, rocket_high_cargo_sums);
            var rocket_mid_panel_opr = math.lusolve(A, rocket_mid_panel_sums);
            var rocket_mid_cargo_opr = math.lusolve(A, rocket_mid_cargo_sums);
            var rocket_low_panel_opr = math.lusolve(A, rocket_low_panel_sums);
            var rocket_low_cargo_opr = math.lusolve(A, rocket_low_cargo_sums);

            var oprs = {};
            var i = 0;
            for (var team in results) {
                oprs[team] = {
                    'cargo_side_panel_opr': cargo_side_panel_opr[i][0],
                    'cargo_side_cargo_opr': cargo_side_cargo_opr[i][0],
                    'cargo_front_panel_opr': cargo_front_panel_opr[i][0],
                    'cargo_front_cargo_opr': cargo_front_cargo_opr[i][0],
                    'rocket_high_panel_opr': rocket_high_panel_opr[i][0],
                    'rocket_high_cargo_opr': rocket_high_cargo_opr[i][0],
                    'rocket_mid_panel_opr': rocket_mid_panel_opr[i][0],
                    'rocket_mid_cargo_opr': rocket_mid_cargo_opr[i][0],
                    'rocket_low_panel_opr': rocket_low_panel_opr[i][0],
                    'rocket_low_cargo_opr': rocket_low_cargo_opr[i][0],
                    'start_avg': start_avgs[i],
                    'climb_avg': climb_avgs[i]
                };
                oprs[team].opr = 
                    oprs[team].cargo_side_panel_opr +
                    oprs[team].cargo_side_cargo_opr +
                    oprs[team].cargo_front_panel_opr +
                    oprs[team].cargo_front_cargo_opr +
                    oprs[team].rocket_high_panel_opr +
                    oprs[team].rocket_high_cargo_opr +
                    oprs[team].rocket_mid_panel_opr +
                    oprs[team].rocket_mid_cargo_opr +
                    oprs[team].rocket_low_panel_opr +
                    oprs[team].rocket_low_cargo_opr +
                    oprs[team].start_avg +
                    oprs[team].climb_avg
                i++;
            }

            callback(oprs);
        });
    }

    genOPRs('2019txaus', function(results) {

        // Cache of the template
        var header = document.getElementById("header-table");
        var template = document.getElementById("template-table-entry");
        // Get the contents of the template
        var headerHtml = header.innerHTML;
        var templateHtml = template.innerHTML;
        // Final HTML variable as empty string
        var listHtml = headerHtml;

        // Loop through dataObject, replace placeholder tags
        // with actual data, and generate final HTML
        for (var team in results) {
          listHtml += templateHtml.replace(/{{url}}/g, "https://www.thebluealliance.com/team/" + team)
                                  .replace(/{{team}}/g, team)
                                  .replace(/{{opr}}/g, results[team].opr.toFixed(2))
                                  .replace(/{{start_avg}}/g, results[team].start_avg.toFixed(2))
                                  .replace(/{{climb_avg}}/g, results[team].climb_avg.toFixed(2))
                                  .replace(/{{cargo_side_panel_opr}}/g, results[team].cargo_side_panel_opr.toFixed(2))
                                  .replace(/{{cargo_side_cargo_opr}}/g, results[team].cargo_side_cargo_opr.toFixed(2))
                                  .replace(/{{cargo_front_panel_opr}}/g, results[team].cargo_front_panel_opr.toFixed(2))
                                  .replace(/{{cargo_front_cargo_opr}}/g, results[team].cargo_front_cargo_opr.toFixed(2))
                                  .replace(/{{rocket_high_panel_opr}}/g, results[team].rocket_high_panel_opr.toFixed(2))
                                  .replace(/{{rocket_high_cargo_opr}}/g, results[team].rocket_high_cargo_opr.toFixed(2))
                                  .replace(/{{rocket_mid_cargo_opr}}/g, results[team].rocket_mid_cargo_opr.toFixed(2))
                                  .replace(/{{rocket_mid_panel_opr}}/g, results[team].rocket_mid_panel_opr.toFixed(2))
                                  .replace(/{{rocket_low_panel_opr}}/g, results[team].rocket_low_panel_opr.toFixed(2))
                                  .replace(/{{rocket_low_cargo_opr}}/g, results[team].rocket_low_cargo_opr.toFixed(2))
                                  .replace(/{{cargo_panel_opr}}/g, (results[team].cargo_side_panel_opr + results[team].cargo_front_panel_opr).toFixed(2))
                                  .replace(/{{cargo_cargo_opr}}/g, (results[team].cargo_side_cargo_opr + results[team].cargo_front_cargo_opr).toFixed(2))
                                  .replace(/{{rocket_panel_opr}}/g, (results[team].rocket_high_panel_opr + results[team].rocket_mid_panel_opr + results[team].rocket_low_panel_opr).toFixed(2))
                                  .replace(/{{rocket_cargo_opr}}/g, (results[team].rocket_high_cargo_opr + results[team].rocket_mid_cargo_opr + results[team].rocket_low_cargo_opr).toFixed(2));
        }

        // Replace the HTML of #list with final HTML
        document.getElementById("opr_table").innerHTML = listHtml;
    });
</script>
</html>